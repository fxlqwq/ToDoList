name: Build and Release APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Run tests
      run: flutter test || echo "Tests failed, continuing build..."
      
    - name: Build APK (Debug)
      if: github.event_name == 'pull_request'
      run: flutter build apk --debug
      
    - name: Build APK (Release)
      if: github.event_name != 'pull_request'
      run: flutter build apk --release
      
    - name: Get version from pubspec.yaml
      id: version
      run: |
        version=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Version: $version"
        
    - name: Rename APK file
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/TodoList-v${{ steps.version.outputs.version }}-debug.apk
        else
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/TodoList-v${{ steps.version.outputs.version }}-release.apk
        fi
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: TodoList-APK-v${{ steps.version.outputs.version }}
        path: |
          build/app/outputs/flutter-apk/*.apk
        retention-days: 30
        
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: TodoList v${{ steps.version.outputs.version }}
        body: |
          ## ğŸ“± TodoList v${{ steps.version.outputs.version }}
          
          ### âœ¨ æ–°åŠŸèƒ½
          - ğŸ“ é¦–æ¬¡ä½¿ç”¨æŒ‡å—ï¼š5æ­¥äº¤äº’å¼æ•™ç¨‹
          - ğŸ”‹ ç”µæ± ä¼˜åŒ–ç®¡ç†ï¼šè‡ªåŠ¨ç”³è¯·åå°è¿è¡Œæƒé™
          - ğŸ” æ™ºèƒ½æƒé™ç”³è¯·ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰å¿…è¦æƒé™
          - ğŸ’¾ åå¥½è®¾ç½®ç³»ç»Ÿï¼šè®°ä½ç”¨æˆ·é€‰æ‹©ï¼Œé¿å…é‡å¤æç¤º
          - ğŸ“± åŸç”Ÿæƒé™é›†æˆï¼šAndroidåŸç”Ÿç”µæ± ä¼˜åŒ–æƒé™å¤„ç†
          
          ### ğŸš€ æ€§èƒ½ä¼˜åŒ–
          - ğŸ“ˆ é€šçŸ¥å¯é æ€§ï¼šä¸‰é‡å¤‡ç”¨è°ƒåº¦ç­–ç•¥
          - ğŸ›¡ï¸ é”™è¯¯å¤„ç†ï¼šå…¨é¢çš„å¼‚å¸¸æ•è·å’Œæ¢å¤æœºåˆ¶
          - âš¡ å¯åŠ¨ä¼˜åŒ–ï¼šæ™ºèƒ½çš„é¦–æ¬¡å¯åŠ¨æµç¨‹
          - ğŸ”„ çŠ¶æ€ç®¡ç†ï¼šä¼˜åŒ–çš„ProviderçŠ¶æ€ç®¡ç†
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„ `TodoList-v${{ steps.version.outputs.version }}-release.apk` æ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå®‰è£…APK
          3. é¦–æ¬¡å¯åŠ¨æ—¶æŒ‰ç…§å¼•å¯¼å®Œæˆæƒé™è®¾ç½®
          4. äº«å—æ™ºèƒ½çš„å¾…åŠäº‹é¡¹ç®¡ç†ä½“éªŒï¼
          
          ### ğŸ”§ æŠ€æœ¯è¦æ±‚
          - Android 5.0+ (API Level 21+)
          - å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
          - å»ºè®®å…è®¸åå°è¿è¡Œä»¥è·å¾—æœ€ä½³é€šçŸ¥ä½“éªŒ
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ [README.md](https://github.com/fxlqwq/ToDoList-Notice-Flutter/blob/main/README.md)**
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/app/outputs/flutter-apk/TodoList-v${{ steps.version.outputs.version }}-release.apk
        asset_name: TodoList-v${{ steps.version.outputs.version }}-release.apk
        asset_content_type: application/vnd.android.package-archive

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.build.result == 'success'
      run: |
        echo "âœ… APK build completed successfully!"
        echo "ğŸ“± Download the APK from the Actions artifacts section"
        
    - name: Notify Failure  
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ APK build failed!"
        echo "ğŸ” Check the build logs for error details"
